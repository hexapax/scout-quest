#cloud-config
package_update: true
package_upgrade: true

packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg
  - lsb-release
  - git
  - jq
  - unzip

runcmd:
  # --- Install Docker (official method) ---
  - install -m 0755 -d /etc/apt/keyrings
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
  - chmod a+r /etc/apt/keyrings/docker.asc
  - echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo $VERSION_CODENAME) stable" > /etc/apt/sources.list.d/docker.list
  - apt-get update
  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

  # --- Install Caddy ---
  - curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
  - curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | tee /etc/apt/sources.list.d/caddy-stable.list
  - apt-get update
  - apt-get install -y caddy

  # --- Create app user ---
  - useradd -r -m -s /bin/bash -G docker scoutcoach
  - mkdir -p /opt/scoutcoach
  - chown scoutcoach:scoutcoach /opt/scoutcoach

  # --- Clone LibreChat (two independent instances) ---
  - sudo -u scoutcoach git clone --depth 1 https://github.com/danny-avila/LibreChat.git /opt/scoutcoach/ai-chat
  - sudo -u scoutcoach git clone --depth 1 https://github.com/danny-avila/LibreChat.git /opt/scoutcoach/scout-quest

  # --- Prepare MCP directory (scout-quest only) ---
  - sudo -u scoutcoach mkdir -p /opt/scoutcoach/scout-quest/mcp-servers/scout-quest

  # --- Prepare admin directory ---
  - sudo -u scoutcoach mkdir -p /opt/scoutcoach/admin

  # --- Write Caddyfile (three reverse proxy blocks) ---
  - |
    cat > /etc/caddy/Caddyfile << 'EOF'
    ${domain_aichat} {
        reverse_proxy localhost:3080
    }

    ${domain_scout} {
        reverse_proxy localhost:3081
    }

    ${domain_admin} {
        reverse_proxy localhost:3082
    }
    EOF
  - systemctl restart caddy

  # --- Signal ready for deploy script ---
  - touch /opt/scoutcoach/.cloud-init-complete

  # --- Log completion ---
  - echo "=== cloud-init complete $(date) ===" >> /var/log/scout-coach-init.log
