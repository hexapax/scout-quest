#cloud-config
package_update: true
package_upgrade: true

packages:
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg
  - lsb-release
  - git
  - jq
  - unzip
  - build-essential

runcmd:
  # --- Install Docker (official method) ---
  - install -m 0755 -d /etc/apt/keyrings
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
  - chmod a+r /etc/apt/keyrings/docker.asc
  - echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo $VERSION_CODENAME) stable" > /etc/apt/sources.list.d/docker.list
  - apt-get update
  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

  # --- Create devuser ---
  - useradd -r -m -s /bin/bash -G docker devuser
  - mkdir -p /opt/devbox
  - chown devuser:devuser /opt/devbox

  # --- Install Node.js 24 via nvm (as devuser) ---
  - |
    sudo -u devuser bash -c '
      curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh | bash
      export NVM_DIR="$HOME/.nvm"
      [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
      nvm install 24
      nvm alias default 24
      # Install Claude Code CLI globally
      npm install -g @anthropic-ai/claude-code
    '

  # --- Create directory structure ---
  - sudo -u devuser mkdir -p /opt/devbox/hooks
  - sudo -u devuser mkdir -p /opt/devbox/telegram-bot
  - sudo -u devuser mkdir -p /opt/devbox/config

  # --- Signal ready ---
  - touch /opt/devbox/.cloud-init-complete

  # --- Log completion ---
  - echo "=== cloud-init complete $(date) ===" >> /var/log/devbox-init.log
